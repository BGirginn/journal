# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Offline-first journaling app with a block-based editor, built with Flutter. Targets iOS, Android, and macOS. Uses Firebase for auth/cloud sync and Drift (SQLite) for local persistence.

## Build & Development Commands

```bash
# Run the app
flutter run

# Run all tests
flutter test

# Run a single test file
flutter test test/hlc_test.dart

# Static analysis
flutter analyze

# Code generation (Drift, Riverpod, JSON serializable)
flutter pub run build_runner build --delete-conflicting-outputs

# Watch mode for code generation
flutter pub run build_runner watch --delete-conflicting-outputs

# Clean build
flutter clean && flutter pub get
```

A `./flutterw` wrapper script exists for local Flutter SDK use.

## Architecture

### Layered Structure

- **`lib/core/`** — Shared infrastructure: database, auth, sync, models, navigation, theme, UI components
- **`lib/features/`** — Feature modules (editor, journal, home, friends, team, profile, etc.)
- **`lib/providers/`** — Riverpod providers for dependency injection

### Key Patterns

- **State management:** Riverpod with code generation (`@riverpod` annotations). Providers live in `lib/providers/` and within feature modules.
- **Database:** Drift ORM with 9 tables in `lib/core/database/tables/` and 8 DAOs in `lib/core/database/daos/`. Database class: `AppDatabase` in `app_database.dart` (schema version 3). Generated files use `.g.dart` suffix.
- **Routing:** GoRouter in `lib/core/navigation/app_router.dart` with auth-aware redirects.
- **Backend:** Firebase Auth (Google Sign-In), Cloud Firestore (document sync), Firebase Storage (media assets). Firebase availability is checked at startup and degrades gracefully if unavailable.
- **Sync:** HLC (Hybrid Logical Clock) based oplog system in `lib/core/sync/`. Operation log tracks changes with status: pending → sent → acked → applied. LWW conflict resolution.

### Editor Engine (`lib/features/editor/`)

The block-based editor is the most complex subsystem:
- **Blocks** (`blocks/`): Four types — text, image, audio, video. Each has normalized [0..1] coordinates, z-index, and transform properties (x, y, width, height, rotation). Block data stored as JSON payloads.
- **Engine** (`engine/`): Orchestrates autosave (debounced), gesture handling, hit testing, and transform math.
- **Commands** (`commands/`): Command pattern for undo/redo.
- **Drawing** (`drawing/`): Ink stroke system stored as `inkData` on pages.

### Data Flow

Firebase Auth → UserService (profile in Firestore `users/{uid}`) → Local Drift DB ↔ Firestore sync via SyncService. Media assets go through StorageService (`users/{uid}/assets/{filename}`).

## Code Style

- **Single quotes** for strings (enforced by linter)
- **`const` constructors** preferred
- **`final` fields** preferred
- **Explicit return types** required
- Linting: `package:flutter_lints/flutter.yaml` with strict additional rules in `analysis_options.yaml`

## Database Migrations

When adding columns or tables, update `AppDatabase.schemaVersion` and add migration logic in `MigrationStrategy.onUpgrade` in `lib/core/database/app_database.dart`. After schema changes, regenerate with `build_runner`.

## Generated Files

Files matching `*.g.dart` are generated by `build_runner`. Do not edit them manually. Regenerate after changing:
- Drift tables/DAOs
- Riverpod providers using `@riverpod`
- Models using `@JsonSerializable`
